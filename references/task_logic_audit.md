# Task Logic Audit: Drifting Double-Bandit

## 1. Paradigm Intent

- Task: `drifting_double_bandit`
- Primary construct: exploration-exploitation control under non-stationary reward contingencies.
- Manipulated factors: trial-wise latent reward probabilities for left and right options (`p_left`, `p_right`) generated by Gaussian drift.
- Dependent measures: choice side, RT, no-response rate, reward outcome, cumulative score, choice-by-probability alignment.
- Key citations:
  - `W2955737617` (restless choice under uncertainty)
  - `W2084489534` (restless bandit with drifting value estimates)
  - `W2027554764` (learning in unstable environments)
  - `W3024348208` (uncertainty-sensitive exploration strategies)

## 2. Block/Trial Workflow

### Block Structure

- Total blocks: `task.total_blocks` (`4` in human; short block profiles in QA/sim).
- Trials per block: `task.trial_per_block` (`40` in human; `12` in QA/sim smoke configs).
- Randomization/counterbalancing:
  - Trial list is generated by `Controller.prepare_block(...)` as a deterministic random walk sequence.
  - `randomize_within_block=false` keeps temporal drift order intact.
  - Seeded per block for reproducibility (`seed + block_idx * 1009`).

### Trial State Machine

1. `pre_choice_fixation`
   - Onset trigger: `pre_choice_fixation_onset` (20; fallback-compatible with `cue_onset`)
   - Stimuli shown: central fixation (`fixation`)
   - Valid keys: none
   - Timeout behavior: auto-advance after `pre_choice_fixation_duration` (fallback-compatible with `cue_duration`)
   - Next state: `bandit_choice`
2. `bandit_choice`
   - Onset trigger: `choice_onset` (30)
   - Response triggers: `choice_left_press` (31), `choice_right_press` (32)
   - Timeout trigger: `choice_no_response` (33), then `choice_imputed` (34) if fallback policy is used
   - Stimuli shown: left/right bandit panels (`machine_left`, `machine_right`) plus labels and choice prompt
   - Valid keys: `[left_key, right_key]` = `[f, j]`
   - Timeout behavior: no key -> impute via controller policy (`random|left|right`)
   - Next state: `choice_confirmation`
3. `choice_confirmation`
   - Onset trigger: `choice_confirmation_onset` (40; fallback-compatible with `target_onset`)
   - Stimuli shown: same option panels + selected highlight (`highlight_left|highlight_right`) + confirmation text
   - Valid keys: none
   - Timeout behavior: auto-advance after `choice_confirmation_duration` (fallback-compatible with `target_duration`)
   - Next state: `outcome_feedback`
4. `outcome_feedback`
   - Onset trigger: `outcome_feedback_win_onset` (50) or `outcome_feedback_loss_onset` (51) (fallback-compatible with `feedback_win_onset` / `feedback_loss_onset`)
   - Stimuli shown: reward/no-reward message with updated running total
   - Valid keys: none
   - Timeout behavior: auto-advance after `outcome_feedback_duration` (fallback-compatible with `feedback_duration`)
   - Next state: `iti`
5. `iti`
   - Onset trigger: `iti_onset` (60)
   - Stimuli shown: central fixation
   - Valid keys: none
   - Timeout behavior: auto-advance after `iti_duration`
   - Next state: next trial or block-end summary

## 3. Condition Semantics

- Condition ID: `bandit`
- Participant-facing meaning: each trial presents two slot-machine options (left/right), one choice is made, then probabilistic outcome is revealed.
- Concrete stimulus realization:
  - Left and right rectangular machine cards at symmetric horizontal anchors.
  - Center-lower choice prompt.
  - Choice confirmation highlight frame around selected side.
  - Center feedback text (win/loss + score).
- Outcome rules:
  - Reward draw: Bernoulli(`p_left`) for left choice, Bernoulli(`p_right`) for right choice.
  - Reward values: `reward_win=10`, `reward_loss=0`.

## 4. Response and Scoring Rules

- Response mapping:
  - `f` -> left machine
  - `j` -> right machine
  - `space` is reserved for instruction/break/exit continue screens only
- Missing-response policy:
  - If no response in choice window, set `missed_choice=true`.
  - Impute choice using `controller.no_choice_policy` (default: `random`), emit `choice_imputed`.
- Correctness logic:
  - No objective correct side in restless bandit; both response keys are valid.
- Reward/penalty updates:
  - Per trial reward delta is `+10` on win, `+0` on loss.
  - `controller.update(...)` increments trial count and cumulative reward.
- Running metrics:
  - Trial-level: `choice_side`, `choice_rt`, `choice_prob`, `reward_win`, `reward_delta`.
  - Block/final summaries: `left_rate`, `win_rate`, `no_response_rate`, `total_score`.

## 5. Stimulus Layout Plan

- Screen: `bandit_choice`
  - Stimulus IDs: `machine_left`, `machine_right`, `machine_left_label`, `machine_right_label`, `choice_prompt`
  - Layout anchors:
    - Left option center: `[-230, 20]`
    - Right option center: `[230, 20]`
    - Prompt: `[0, -220]`
  - Size/spacing:
    - Machine cards: `240x300` px
    - Horizontal separation: `460` px center-to-center
    - Prompt `height=30`, `wrapWidth=980`
  - Readability checks:
    - Labels are centered within each card and do not overlap prompt region.
    - Prompt sits below cards with >130 px vertical separation.
- Screen: `choice_confirmation`
  - Stimulus IDs: machine cards + labels + one highlight + `target_prompt`
  - Layout anchors:
    - Same card anchors as choice screen
    - Confirmation prompt: `[0, 220]`
  - Size/spacing:
    - Highlight frame: `270x330` px, line width `5`
    - Confirmation text `height=34`, `wrapWidth=980`
  - Readability checks:
    - Top confirmation text is vertically separated from card labels.
    - Highlight frame encloses exactly one card and is never ambiguous.
- Rationale:
  - Symmetric left-right anchors preserve a binary choice structure and avoid hidden condition cues.
  - Prompt placement above/below card row separates decision vs confirmation semantics.

## 6. Trigger Plan

- Experiment:
  - `exp_onset` = 1
  - `exp_end` = 2
- Block:
  - `block_onset` = 10
  - `block_end` = 11
- Trial:
  - `pre_choice_fixation` -> `pre_choice_fixation_onset` = 20 (fallback: `cue_onset`)
  - `bandit_choice` onset -> `choice_onset` = 30
  - choice response -> `choice_left_press` = 31 / `choice_right_press` = 32
  - choice timeout -> `choice_no_response` = 33
  - imputed response marker -> `choice_imputed` = 34
  - `choice_confirmation` onset -> `choice_confirmation_onset` = 40 (fallback: `target_onset`)
  - `outcome_feedback` onset -> `outcome_feedback_win_onset` = 50 / `outcome_feedback_loss_onset` = 51 (fallback: `feedback_win_onset` / `feedback_loss_onset`)
  - `iti` onset -> `iti_onset` = 60

## 7. Inference Log

- Decision: use explicit `choice_confirmation` stage between response and feedback.
  - Why inference was required: references emphasize event separation and decision commitment but do not prescribe a fixed duration for all implementations.
  - Citation-supported rationale: aligns with temporal decomposition in `W3024348208` and improves trigger interpretability.
- Decision: score as `+10 / +0` discrete points.
  - Why inference was required: papers report reward outcomes/probabilities, not a mandatory UI point scale.
  - Citation-supported rationale: preserves binary reinforcement signal while enabling participant-understandable cumulative progress (`W2955737617`, `W2084489534`).
- Decision: deterministic symmetric card layout with fixed pixel anchors.
  - Why inference was required: references specify binary options but not exact screen coordinates.
  - Citation-supported rationale: symmetric side-by-side display is standard for two-arm bandit perceptual clarity and avoids condition leakage.
